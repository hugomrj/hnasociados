{% extends 'base.html' %}
{% load static %}
{% load filters %}


{% block content %}
<div class="container mt-4">


    <div class="card">

        <div class="card-header">
            <h5 class="mb-0">Pagos</h5>  
        </div>

        <div class="card-body">





            <form>

                <div class="mb-4 row">
                    <div class="form-field col-md-8">
                        <div class="row">
                            <label for="cliente" class="col-form-label">Cliente</label>
                            <div class="col-sm-8">
                                <select id="cliente" name="cliente" class="form-control">
                                    <option value="">-- Seleccione --</option>
                                    {% for cliente in clientes %}
                                        <option value="{{ cliente.cedula }}" 
                                            {% if cliente.cedula == cedula %} 
                                                selected 
                                            {% endif %}>
                                            {{ cliente.nombre }} {{ cliente.apellido }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                


                <div class="mb-4 row">
                    <div class="form-field col-md-6">
                        <div class="row">
                            <label for="cedula" class="col-form-label">C칠dula</label>
                            <div class="col-sm-4">
                                <input type="text" 
                                    name="cedula"  
                                    class="form-control" 
                                    id="cedula"
                                    value="{{ cedula }}"  
                                    disabled>                  
                            </div>
                        </div>
                    </div>
                
                    <!-- 游녤 Campo tarifa en el mismo row -->
                    <div class="form-field col-md-6">
                        <div class="row">
                            <label for="tarifa" class="col-form-label">Monto cuota</label>
                            <div class="col-sm-6">
                                <input type="text" 
                                    name="tarifa"  
                                    class="form-control" 
                                    id="tarifa"
                                    value="{{ tarifa|default_if_none:'' }}"  
                                    disabled>                  
                            </div>
                        </div>
                    </div>
                </div>
                





                

                <!-- Bloque de Obligaciones -->
                <div class="mb-4 row">
                    <label class="col-form-label">Obligaciones</label>
                    <div class="col-sm-12">
                        {% if obligaciones %}
                            {% for ob in obligaciones %}
                                <button type="button" class="btn btn-light btn-rounded" data-mdb-ripple-init>
                                    {{ ob.descripcion }}
                                </button>
                            {% endfor %}
                        {% else %}
                            <p>No tiene obligaciones asignadas</p>
                        {% endif %}
                    </div>
                </div>
                





            </form>



                <!-- Fila con el bot칩n de agregar y el campo de b칰squeda -->
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <!-- Bot칩n Agregar -->
                    <a href="{% url 'pago:add' cliente_id %}" 
                        class="btn btn-primary btn-sm"
                        style="width: 120px;">
                        <i class="fas fa-plus"></i> Agregar
                    </a>

                </div>            




            <table class="table table-hover">
                <thead>
                    <tr class="table-light">
                        
                        <th class="text-center text-nowrap">Fecha</th>
                        <th class="text-center text-nowrap">Mes/A침o</th>

                        <th class="text-center text-nowrap">Monto</th>

                        <th class="text-center text-nowrap">Acciones</th>
                    </tr>
                </thead>
                <tbody class="table-group-divider">                    
                    {% for item in lista %}
                    <tr>
                        
                        <td>{{ item.fecha }}</td>

                        <td>{{ item.mes_pago }}/{{ item.anio_pago }}</td>

                        <td>{{ item.monto|miles_puntos }}</td>

                        
                        <td class="text-center">
                            <div class="d-flex justify-content-center gap-2">
                                <a href="{% url 'pago:detail' item.pk %}" 
                                   class="text-primary p-0" title="Ver">
                                    <i class="fas fa-eye"></i>
                                </a>
            
                                <a href="{% url 'pago:edit' item.pk %}" 
                                   class="text-warning p-0" title="Editar">
                                    <i class="fas fa-edit"></i>
                                </a>
            
                                <a href="#" class="text-danger p-0 delete-btn" 
                                   title="Borrar"
                                   data-item-id="{{ item.pk }}"
                                   data-delete-url="{% url 'pago:delete' item.pk %}">
                                    <i class="fas fa-trash-alt"></i>
                                </a>


                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
                        

        <!-- Paginaci칩n -->
        <div class="mt-4">
            {% include 'pagination.html' %}
        </div>





        </div>
    </div>
    <!-- card -->



</div>
{% endblock %}


{% block extrascripts %}  
<script src="{% static 'js/common.js' %}"></script>

<script>

    document.addEventListener("DOMContentLoaded", function() {
        let selectCliente = new SlimSelect({
            select: '#cliente',
            placeholder: 'Seleccione un cliente',
            allowDeselect: true,
            events: {
                afterChange: (info) => {            
                    
                    let cedula = (info[0]?.value || "0")
                    
                    document.getElementById("cedula").value = cedula

                    // Redirigir a la misma p치gina con el par치metro cedula
                    const currentUrl = window.location.pathname;  // Obtiene la URL actual sin par치metros
                    const newUrl = new URL(window.location.href);  // Obtiene la URL completa
                    newUrl.searchParams.set('cedula', cedula);  // Agrega o actualiza el par치metro cedula
                    window.location.href = newUrl.href;  // Redirige a la nueva URL

                }
            }
        });
    });

</script>
{% endblock %}
